<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI 競品分析與策略儀表板 (專家版)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Noto Sans TC', sans-serif;
            background-color: #f0f2f5;
        }
        .table-sticky-header th {
            position: sticky;
            top: 0;
            background-color: #f9fafb;
            z-index: 10;
        }
        .competitor-card {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            background-color: #f9fafb;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
        .timeline-item::before {
            content: '';
            position: absolute;
            left: -31px;
            top: 5px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background-color: white;
            border-width: 4px;
        }
        .timeline-item-my_brand::before { border-color: #4f46e5; }
        .timeline-item-direct::before { border-color: #db2777; }
        .timeline-item-indirect::before { border-color: #f59e0b; }
        .timeline-item-potential::before { border-color: #10b981; }
        .timeline-item:not(:last-child)::after {
            content: '';
            position: absolute;
            left: -22px;
            top: 25px;
            width: 2px;
            height: calc(100% + 1.5rem);
            background-color: #e0e0e0;
        }
        .predicted-event {
            border-style: dashed !important;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <div class="max-w-2xl mx-auto mb-6 bg-yellow-50 border border-yellow-200 rounded-lg p-4 flex flex-col md:flex-row items-center gap-3">
            <span class="font-semibold text-yellow-800">Google Gemini API Key：</span>
            <input type="password" id="api-key-input" class="flex-1 px-3 py-2 border border-gray-300 rounded-md text-base" placeholder="請貼上你的 Google AI API Key" />
            <button id="save-api-key-btn" class="bg-yellow-600 text-white px-4 py-2 rounded hover:bg-yellow-700">儲存</button>
            <span id="api-key-status" class="ml-2 text-green-600 text-sm hidden">已儲存!</span>
        </div>

        <header class="text-center mb-8">
            <h1 class="text-3xl md:text-4xl font-bold text-gray-900">AI 競品分析與策略儀表板 (專家版)</h1>
            <p class="mt-2 text-gray-600">輸入您的品牌、策略目標與競品，AI 將提供全面性的策略分析與洞察。</p>
        </header>

        <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
            <div id="market-focus-card" class="bg-gradient-to-r from-indigo-50 to-purple-50 border border-indigo-200 rounded-xl p-6 shadow-sm mb-6">
                <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                    <div>
                        <p class="text-sm font-semibold text-indigo-600 uppercase tracking-wider mb-1">市場聚焦</p>
                        <p class="text-lg font-bold text-gray-900">目前預設：<span id="market-region-label" class="text-indigo-700">台灣</span></p>
                        <p id="market-hint-text" class="text-sm text-gray-600 mt-1">這會影響 AI 分析角度、語言建議、商業模式比對與社群聲量地區篩選。</p>
                    </div>
                    <div class="flex items-center gap-3">
                        <label for="market-select" class="text-sm font-medium text-gray-700">切換市場</label>
                        <select id="market-select" class="px-4 py-2 border border-gray-300 rounded-md focus:ring-2 focus:ring-indigo-400 bg-white">
                            <option value="台灣" selected>台灣</option>
                            <option value="東南亞">東南亞</option>
                            <option value="日本">日本</option>
                            <option value="美國">美國</option>
                            <option value="歐洲">歐洲</option>
                            <option value="中國">中國</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-x-8 gap-y-6">
                <div class="space-y-4">
                    <div>
                        <label for="my-brand-input" class="block text-sm font-medium text-gray-700 mb-1">您的品牌</label>
                        <input type="text" id="my-brand-input" class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" />
                    </div>
                    <div>
                        <label for="industry-select" class="block text-sm font-medium text-gray-700 mb-1">行業類別</label>
                        <select id="industry-select" class="w-full px-4 py-3 text-lg border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition">
                            <option value="">請選擇行業</option>
                            <option value="科技/軟體">科技/軟體</option>
                            <option value="電子商務/零售">電子商務/零售</option>
                            <option value="金融科技">金融科技</option>
                            <option value="醫療/健康">醫療/健康</option>
                            <option value="教育科技">教育科技</option>
                            <option value="製造業/B2B">製造業/B2B</option>
                            <option value="餐飲/食品">餐飲/食品</option>
                            <option value="時尚/美妝">時尚/美妝</option>
                            <option value="旅遊/住宿">旅遊/住宿</option>
                            <option value="媒體/娛樂">媒體/娛樂</option>
                            <option value="房地產">房地產</option>
                            <option value="能源/環保">能源/環保</option>
                            <option value="其他">其他</option>
                        </select>
                    </div>
                    <div>
                        <label for="product-description-input" class="block text-sm font-medium text-gray-700 mb-1">產品/服務描述（請詳細說明）</label>
                        <textarea id="product-description-input" rows="3" class="w-full px-4 py-2 text-base border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="請詳細描述您的產品或服務，包括核心功能、目標用戶、使用場景等"></textarea>
                    </div>
                    <div>
                        <label for="my-goal-input" class="block text-sm font-medium text-gray-700 mb-1">本季行銷目標</label>
                        <textarea id="my-goal-input" rows="2" class="w-full px-4 py-2 text-base border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                    <div>
                        <label for="my-persona-input" class="block text-sm font-medium text-gray-700 mb-1">目標受眾輪廓 (Persona)</label>
                        <textarea id="my-persona-input" rows="3" class="w-full px-4 py-2 text-base border-2 border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition"></textarea>
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">競爭對手</label>
                    <div id="competitor-list" class="space-y-3"></div>
                    <button id="add-competitor-btn" class="mt-3 w-full text-indigo-600 border-2 border-dashed border-indigo-300 hover:border-indigo-500 hover:bg-indigo-50 font-semibold py-2 px-4 rounded-lg transition">+ 新增競品</button>
                </div>
            </div>
            <div class="mt-6">
                <button id="analyze-btn" class="w-full bg-indigo-600 text-white font-bold px-8 py-4 text-lg rounded-lg hover:bg-indigo-700 transition-transform transform hover:scale-101 focus:outline-none focus:ring-4 focus:ring-indigo-300">
                    <span class="flex items-center justify-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M14 10V3.5a1.5 1.5 0 00-3 0V10m8 4V10m0 0c0 4-2.5 7-8 7s-8-3-8-7c0-3 4-6 8-6s8 3 8 6z" /></svg>
                        開始深度分析
                    </span>
                </button>
            </div>
        </div>

        <div id="loader" class="text-center py-10 hidden">
            <div role="status" class="flex justify-center items-center flex-col">
                <svg aria-hidden="true" class="w-12 h-12 mb-4 text-gray-200 animate-spin dark:text-gray-600 fill-indigo-600" viewBox="0 0 100 101" fill="none" xmlns="http://www.w3.org/2000/svg"><circle cx="50" cy="50" r="45" stroke="currentColor" stroke-width="10" fill="none"/><path d="M100 50A50 50 0 1 1 0 50a50 50 0 0 1 100 0z" fill="currentColor"/></svg>
                <p class="text-lg text-gray-600 font-semibold">AI 正在進行深度比較分析，請稍候...</p>
                <p class="text-sm text-gray-500 mt-1">這可能需要 90-180 秒</p>
            </div>
        </div>

        <div id="error-message" class="text-center p-4 bg-red-100 text-red-700 rounded-lg hidden"></div>

        <div id="results-container" class="hidden space-y-8">
        <div class="flex justify-between items-center mb-0">
            <h2 class="text-3xl font-bold text-gray-800">分析結果</h2>
            <div class="flex items-center gap-3">
                <button id="validate-sources-btn" class="bg-indigo-100 text-indigo-700 font-semibold px-4 py-2 rounded-lg hover:bg-indigo-200 transition focus:outline-none focus:ring-4 focus:ring-indigo-200">
                    來源驗證
                </button>
                <button id="save-snapshot-btn" class="bg-gray-100 text-gray-700 font-semibold px-4 py-2 rounded-lg hover:bg-gray-200 transition focus:outline-none focus:ring-4 focus:ring-gray-200">
                    儲存快照
                </button>
                <button id="download-btn" class="bg-green-600 text-white font-bold px-6 py-2 rounded-lg hover:bg-green-700 transition focus:outline-none focus:ring-4 focus:ring-green-300">
                    <span class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm4-7a1 1 0 112 0v4a1 1 0 11-2 0v-4zm4-1a1 1 0 10-2 0v5a1 1 0 002 0v-5z" clip-rule="evenodd" /></svg>
                        下載 PDF 報告
                    </span>
                </button>
            </div>
        </div>
            <div id="downloadable-content" class="space-y-8">
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">社群聲量趨勢圖</h2>
                    <div class="p-6 pt-0">
                        <canvas id="social-buzz-chart"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg overflow-x-auto">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">競品比較矩陣</h2>
                <table id="comparison-table" class="min-w-full text-sm text-left"></table>
                    <div id="comparison-sources" class="mt-4 grid grid-cols-1 md:grid-cols-3 gap-4 hidden"></div>
                    <div id="public-info-sources" class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4 hidden"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">量化指標比較</h2>
                    <div class="p-6">
                        <canvas id="metric-comparison-chart" class="w-full h-60"></canvas>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">維度說明</h2>
                    <div id="dimension-guide" class="p-6 grid gap-4 sm:grid-cols-2"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">整合行銷活動時間軸</h2>
                    <div id="timeline-container" class="relative border-l-2 border-gray-200 ml-8 p-6 pt-0"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">機會與威脅警報</h2>
                    <div id="alerts-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">7維度 AIO 品牌感知系統 (GEO戰略)</h2>
                    <div id="aio-awareness-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">快速情緒脈動監測</h2>
                    <div id="sentiment-pulse-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">QDAC 決策框架</h2>
                    <div id="qdac-framework-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">市場進入策略分析</h2>
                    <div id="market-entry-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">行業完整性分析</h2>
                    <div id="industry-analysis-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">產品描述明確化</h2>
                    <div id="product-clarification-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">語言本地化建議</h2>
                    <div id="language-recommendations-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold text-gray-800 p-6">當地市場商業模式比對</h2>
                    <div id="local-business-model-container" class="px-6 pb-6 space-y-4"></div>
                </div>
                <div class="bg-white p-6 md:p-8 rounded-xl shadow-lg">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">
                        <span class="flex items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2 text-indigo-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" /></svg>
                            AI 策略分析與洞察
                        </span>
                    </h2>
                    <div id="ai-summary" class="text-gray-700 leading-relaxed prose prose-lg max-w-none"></div>
                </div>
                <div id="analysis-snapshots" class="hidden bg-white rounded-xl shadow-lg p-6 space-y-4">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-lg font-semibold text-gray-800">分析快照</p>
                            <p class="text-xs text-gray-500">儲存/重播曾做過的品牌 + 競品分析</p>
                        </div>
                        <span class="text-xs text-gray-500">最多保留 5 筆</span>
                    </div>
                    <div id="analysis-snapshot-list" class="space-y-4"></div>
                </div>
            </div>
        </div>
    </div>
    <div id="source-validation-modal" class="fixed inset-0 hidden z-50 items-center justify-center bg-black/40 p-4">
        <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full">
            <div class="flex items-center justify-between px-6 py-4 border-b">
                <div>
                    <h3 class="text-lg font-semibold text-gray-900">來源驗證參考</h3>
                    <p class="text-xs text-gray-500">點擊下方連結即可打開實際資料來源或範例頁面。</p>
                </div>
                <button id="close-source-validation" class="text-gray-400 hover:text-gray-700 transition focus:outline-none">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M6.293 6.293a1 1 0 011.414 0L10 8.586l2.293-2.293a1 1 0 111.414 1.414L11.414 10l2.293 2.293a1 1 0 01-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 01-1.414-1.414L8.586 10 6.293 7.707a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                </button>
            </div>
            <div class="px-6 py-5 space-y-4" id="source-validation-list">
                <!-- Links generated dynamically -->
            </div>
        </div>
    </div>

<script type="module">
const myBrandInput = document.getElementById('my-brand-input');
const industrySelect = document.getElementById('industry-select');
const productDescriptionInput = document.getElementById('product-description-input');
const myGoalInput = document.getElementById('my-goal-input');
const myPersonaInput = document.getElementById('my-persona-input');
const competitorList = document.getElementById('competitor-list');
const addCompetitorBtn = document.getElementById('add-competitor-btn');
const analyzeBtn = document.getElementById('analyze-btn');
const loader = document.getElementById('loader');
const resultsContainer = document.getElementById('results-container');
const errorMessage = document.getElementById('error-message');
const socialBuzzChartCanvas = document.getElementById('social-buzz-chart');
const comparisonTable = document.getElementById('comparison-table');
const metricComparisonChartCanvas = document.getElementById('metric-comparison-chart');
const timelineContainer = document.getElementById('timeline-container');
const alertsContainer = document.getElementById('alerts-container');
const summaryContainer = document.getElementById('ai-summary');
const downloadBtn = document.getElementById('download-btn');
const saveSnapshotBtn = document.getElementById('save-snapshot-btn');
const apiKeyInput = document.getElementById('api-key-input');
const saveApiKeyBtn = document.getElementById('save-api-key-btn');
const apiKeyStatus = document.getElementById('api-key-status');
const marketSelect = document.getElementById('market-select');
const marketRegionLabel = document.getElementById('market-region-label');
const marketHintText = document.getElementById('market-hint-text');

const appState = {
    currentRegion: marketSelect?.value || '台灣'
};

const snapshotStorageKey = 'ai_competitor_snapshots';
const snapshotLimit = 5;
let analysisSnapshots = loadSnapshots();
let lastAnalysisData = null;
let lastInputState = null;
let socialBuzzChart = null;
let metricComparisonChart = null;
const comparisonSourcesData = [
    {
        title: '核心體驗',
        description: '產品與價值面對比',
        borderClass: 'border-indigo-200',
        bgClass: 'bg-indigo-50',
        sources: [
            { label: '內部品牌/產品說明', note: '產品定位、價值主張', tooltip: '策略/PRD 文件、內部 USP 簡報' },
            { label: '競品官網與產品頁', note: '功能/體驗差異', tooltip: '可直接比對功能清單與 UI' },
            { label: 'AI 專家比較文本', note: 'Gemini JSON 分析內容', tooltip: '會從 prompt 指令補出各項觀察' },
        ]
    },
    {
        title: '市場 / 行銷',
        description: '通路、定價與社群節奏',
        borderClass: 'border-amber-200',
        bgClass: 'bg-amber-50',
        sources: [
            { label: '公開定價與促案', note: '官網、報價單', tooltip: '包含套餐、免費試用、訂閱/一次性策略' },
            { label: '社群監測報表', note: '聲量高峰與話題', tooltip: '可接 Brand24、Mention、社群 API 導出' },
            { label: 'Media/PR 報導', note: '品牌聲譽與活動', tooltip: '涵蓋 KOL/合作曝光與重大行銷節奏' },
        ]
    },
    {
        title: '資源能力 / 策略彈性',
        description: '組織資源與信任基礎',
        borderClass: 'border-emerald-200',
        bgClass: 'bg-emerald-50',
        sources: [
            { label: '公開財報/募資公告', note: '資金與研發投入', tooltip: '用於推估資源強度與研發速度' },
            { label: '合作/代理網絡', note: '通路與客服', tooltip: '包含線下代理、客服與物流能力' },
            { label: 'AI 自動化/人員佈局', note: '行銷/運營隊伍', tooltip: '可用 LinkedIn、Press 釋出資料佐證' },
        ]
    }
];

apiKeyInput.value = localStorage.getItem('gemini_api_key') || '';
saveApiKeyBtn.addEventListener('click', () => {
    const key = apiKeyInput.value.trim();
    if (key) {
        localStorage.setItem('gemini_api_key', key);
        apiKeyStatus.classList.remove('hidden');
        setTimeout(() => apiKeyStatus.classList.add('hidden'), 2000);
    }
});

addCompetitorBtn.addEventListener('click', addCompetitorField);
analyzeBtn.addEventListener('click', handleAnalysis);
downloadBtn.addEventListener('click', downloadReport);

addCompetitorField();

function updateMarketContext(region) {
    const normalized = region || '台灣';
    appState.currentRegion = normalized;
    if (marketRegionLabel) marketRegionLabel.textContent = normalized;
    if (marketHintText) {
        marketHintText.textContent = `目前以 ${normalized} 市場進行所有分析與聲量篩選。`;
    }
}

if (marketSelect) {
    updateMarketContext(marketSelect.value);
    marketSelect.addEventListener('change', () => updateMarketContext(marketSelect.value));
}

const validateSourcesBtn = document.getElementById('validate-sources-btn');
const closeSourceValidationBtn = document.getElementById('close-source-validation');
const sourceValidationModalEl = document.getElementById('source-validation-modal');
if (validateSourcesBtn) {
    validateSourcesBtn.addEventListener('click', () => {
        renderSourceValidationLinks();
        toggleSourceValidationModal(true);
    });
}
if (closeSourceValidationBtn) {
    closeSourceValidationBtn.addEventListener('click', () => toggleSourceValidationModal(false));
}
if (sourceValidationModalEl) {
    sourceValidationModalEl.addEventListener('click', (event) => {
        if (event.target === sourceValidationModalEl) {
            toggleSourceValidationModal(false);
        }
    });
}
if (saveSnapshotBtn) {
    saveSnapshotBtn.addEventListener('click', saveSnapshot);
}
renderSnapshotList();

function addCompetitorField(initialData = {}) {
    const newField = document.createElement('div');
    newField.className = 'competitor-card';
    newField.innerHTML = `
        <input type="text" class="flex-grow w-full px-3 py-2 text-base border border-gray-300 rounded-md focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition" placeholder="競品名稱" />
        <select class="px-3 py-2 text-base border border-gray-300 rounded-md focus:ring-1 focus:ring-indigo-500 focus:border-indigo-500 transition">
            <option value="direct">直接競品</option>
            <option value="indirect">間接競品</option>
            <option value="potential">潛在競品</option>
        </select>
        <button type="button" class="text-gray-400 hover:text-red-500" onclick="this.parentElement.remove()">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM8.707 7.293a1 1 0 00-1.414 1.414L10 11.414l2.707-2.707a1 1 0 10-1.414-1.414l-1.293 1.293-1.293-1.293z" clip-rule="evenodd" /></svg>
        </button>
    `;
    const input = newField.querySelector('input');
    const select = newField.querySelector('select');
    if (initialData.name) input.value = initialData.name;
    if (initialData.type) select.value = initialData.type;
    competitorList.appendChild(newField);
}

async function handleAnalysis() {
    const myBrand = {
        name: myBrandInput.value.trim(),
        industry: industrySelect.value.trim(),
        productDescription: productDescriptionInput.value.trim(),
        goal: myGoalInput.value.trim(),
        persona: myPersonaInput.value.trim(),
    };
    const competitors = Array.from(competitorList.children).map(div => ({
        name: div.querySelector('input').value.trim(),
        type: div.querySelector('select').value
    })).filter(c => c.name);

    if (!myBrand.name || competitors.length === 0) {
        showError('請輸入您的品牌，並至少新增一個有效的競品。');
        return;
    }
    if (!myBrand.industry) {
        showError('請選擇行業類別。');
        return;
    }
    if (!myBrand.productDescription) {
        showError('請詳細描述您的產品或服務。');
        return;
    }

    resultsContainer.classList.add('hidden');
    errorMessage.classList.add('hidden');
    loader.classList.remove('hidden');
    analyzeBtn.disabled = true;
    analyzeBtn.classList.add('cursor-not-allowed', 'opacity-70');

    try {
        const region = appState.currentRegion || marketSelect?.value || '台灣';
        lastInputState = {
            brand: { ...myBrand },
            competitors: competitors.map(c => ({ ...c })),
            region
        };
        const analysisData = await fetchAndAnalyzeData(myBrand, competitors, region);
        if (!analysisData || !analysisData.analysisResults || !analysisData.aiStrategicAnalysis) {
            throw new Error('AI 回應資料結構不完整，無法進行分析。');
        }
        if (!analysisData.combinedTimeline) analysisData.combinedTimeline = [];
        if (!analysisData.socialBuzzTrend) analysisData.socialBuzzTrend = { labels: [], datasets: [] };
        if (!analysisData.alerts) analysisData.alerts = [];
        if (!analysisData.rapidSentimentPulse) analysisData.rapidSentimentPulse = null;
        if (!analysisData.qdacFramework) analysisData.qdacFramework = null;
        if (!analysisData.marketEntryStrategy) analysisData.marketEntryStrategy = null;
        if (!analysisData.industryAnalysis) analysisData.industryAnalysis = null;
        if (!analysisData.productClarification) analysisData.productClarification = null;
        if (!analysisData.languageRecommendations) analysisData.languageRecommendations = null;
        if (!analysisData.localBusinessModelComparison) analysisData.localBusinessModelComparison = null;
        lastAnalysisData = analysisData;
        renderResults(analysisData);
        resultsContainer.classList.remove('hidden');
    } catch (error) {
        console.error('分析過程中發生錯誤:', error);
        showError(`分析失敗：${error.message}`);
    } finally {
        loader.classList.add('hidden');
        analyzeBtn.disabled = false;
        analyzeBtn.classList.remove('cursor-not-allowed', 'opacity-70');
    }
}

async function fetchAndAnalyzeData(myBrand, competitors, region = '台灣') {
    const competitorsString = competitors.map(c => `「${c.name}」(${c.type}競品)`).join('、');
    const prompt = `
作為一名頂尖的市場策略顧問與決策智能專家，請以 ${region} 市場的文化與競爭脈絡為背景，對品牌「${myBrand.name}」(我方品牌，行業：${myBrand.industry || '未指定'}，產品描述：${myBrand.productDescription || '未提供'}) 與其競爭對手 ${competitorsString} 進行深度、全面的戰略分析。本分析需採用「10維度競爭者矩陣」框架，並整合「7維度AIO品牌感知系統（GEO戰略）」、「快速情緒脈動監測」與「市場進入策略評估」。

【重要分析要求】：
1. **行業完整性分析**：請針對「${myBrand.industry}」行業進行完整的市場結構分析，包括行業標準、主要玩家、進入門檻、監管環境等。
2. **產品描述明確化**：基於「${myBrand.productDescription}」，請明確分析產品的核心價值主張、功能特色、目標用戶群體、使用場景，並與競品進行詳細對比。
3. **語言相關建議**：針對 ${region} 市場，請提供語言本地化建議，包括：
   - 適合的語言版本（如繁體中文、簡體中文、日語、英語、東南亞各國語言等）
   - 關鍵詞與術語的本地化翻譯建議
   - 文化敏感度與語言習慣考量
   - SEO/GEO 關鍵詞策略建議
4. **當地市場商業模式比對**：請深入分析 ${region} 市場的商業模式特點，包括：
   - 當地消費習慣與支付偏好
   - 通路結構與分銷模式
   - 定價策略與促銷習慣
   - 法規與合規要求
   - 競爭對手的商業模式在當地市場的適應性
   - 我方品牌商業模式在當地市場的優劣勢

請針對每個品牌進行以下分析：

【10維度競爭者矩陣】（每個維度請提供0-10分評分、分析文字、資料來源與量化指標）：
1. 產品特徵密度 (Product Feature Density)：產品線廣度與深度、解決痛點覆蓋率
2. 價格定位彈性 (Price Positioning Elasticity)：定價策略結構、折扣頻率、利潤結構
3. 數位權威與足跡 (Digital Authority & Footprint)：網域權重、反向連結、關鍵字覆蓋
4. 社群互動速率 (Social Engagement Velocity)：每千名粉絲的活躍互動比率、內容傳播速度
5. 客戶情緒極性 (Customer Sentiment Polarity)：正負面情緒淨值、情緒觸發點分析
6. 通路網絡廣度 (Distribution Network Breadth)：線上電商平台覆蓋率、線下實體通路滲透率
7. 創新節奏 (Innovation Cadence)：新產品/專利/功能更新頻率
8. 永續與企業社會責任 (Sustainability & CSR Profile)：ESG承諾與實踐
9. 客戶支援響應度 (Customer Support Responsiveness)：各接觸點回應速度與解決能力
10. 品牌敘事一致性 (Brand Narrative Consistency)：跨市場、跨通路訊息統一性

【7維度AIO品牌感知系統】（針對生成式引擎優化GEO）：
1. 提及聲量 (Mention Volume / AI Signal Rate)：AI生成回應中品牌出現頻率
2. 生成式佔有率 (Generative Share of Voice, G-SoV)：在所有競品提及中本品牌佔比
3. 排名與位序 (Rank & Positioning)：AI列表式回答中的順位
4. 提及情緒 (Sentiment of Mention)：AI提及品牌時的形容詞與語境情緒
5. 實體關聯強度 (Entity Association Strength)：品牌與關鍵概念（創新/環保/低價等）連結緊密度
6. 引用準確性與信任度 (Citation Accuracy & Trust)：AI生成資訊的正確性與可信度
7. 推薦強度 (Recommendation Intensity)：被動提及 vs 主動推薦的區分

【快速情緒脈動監測】：
- 整體情緒淨值（正負面比例）
- 主題建模分析（產品/服務/行銷情緒分離）
- 情緒觸發點識別
- 異常波動檢測（尖峰預警）

【市場進入策略評估】：
- 市場機會識別（白色空間）
- 不對稱優勢分析
- 進入路徑建議（D2C/通路/合作夥伴）
- 風險評估與緩解策略

同時請提供：
1. 每個分析維度的「來源文字」（官網、報導、社群聲量、AI推論等），串成 'analysisSources' object
2. 該維度的 'quantifiedMetrics'（更新頻率、社群聲量、App評分、價格數據等）
3. 用 'regionTag' 標註這份分析針對的市場
請嚴格只輸出**純 JSON 結構**（不要加任何說明、註解、也不要用 markdown code block），內容如下：
{
    "analysisResults": [
        {
            "brandName": "...",
            "competitorType": "...",
            "tenDimensionMatrix": {
                "productFeatureDensity": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "pricePositioningElasticity": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "digitalAuthorityFootprint": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "socialEngagementVelocity": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "customerSentimentPolarity": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "distributionNetworkBreadth": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "innovationCadence": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "sustainabilityCSR": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "customerSupportResponsiveness": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} },
                "brandNarrativeConsistency": { "score": 0-10, "analysis": "...", "source": "...", "metrics": {} }
            },
            "aioBrandAwareness": {
                "mentionVolume": { "value": "...", "analysis": "...", "source": "..." },
                "generativeShareOfVoice": { "value": "...", "analysis": "...", "source": "..." },
                "rankPositioning": { "value": "...", "analysis": "...", "source": "..." },
                "sentimentOfMention": { "value": "...", "analysis": "...", "source": "..." },
                "entityAssociationStrength": { "value": "...", "analysis": "...", "source": "..." },
                "citationAccuracyTrust": { "value": "...", "analysis": "...", "source": "..." },
                "recommendationIntensity": { "value": "...", "analysis": "...", "source": "..." }
            },
            "regionTag": "${region}"
        }
    ],
    "rapidSentimentPulse": {
        "overallSentimentNet": { "positive": 0-100, "negative": 0-100, "neutral": 0-100 },
        "topicModeling": [
            { "topic": "產品", "sentiment": "positive/negative/neutral", "percentage": 0-100 },
            { "topic": "服務", "sentiment": "positive/negative/neutral", "percentage": 0-100 },
            { "topic": "行銷", "sentiment": "positive/negative/neutral", "percentage": 0-100 }
        ],
        "sentimentTriggers": ["..."],
        "spikeAlerts": [
            { "type": "positive/negative", "description": "...", "timestamp": "..." }
        ]
    },
    "marketEntryStrategy": {
        "whiteSpaceOpportunities": ["..."],
        "asymmetricAdvantages": ["..."],
        "entryPathRecommendations": [
            { "path": "D2C/通路/合作夥伴", "rationale": "...", "riskLevel": "low/medium/high" }
        ],
        "riskAssessment": {
            "identifiedRisks": ["..."],
            "mitigationStrategies": ["..."]
        }
    },
    "qdacFramework": {
        "question": "...",
        "data": "...",
        "analysis": "...",
        "communication": "..."
    },
    "industryAnalysis": {
        "industryStructure": "...",
        "keyPlayers": ["..."],
        "entryBarriers": ["..."],
        "regulatoryEnvironment": "..."
    },
    "productClarification": {
        "coreValueProposition": "...",
        "keyFeatures": ["..."],
        "targetUserGroups": ["..."],
        "useCases": ["..."],
        "competitiveDifferentiation": "..."
    },
    "languageRecommendations": {
        "recommendedLanguages": ["..."],
        "localizationKeywords": [
            { "term": "...", "translation": "...", "context": "..." }
        ],
        "culturalSensitivity": ["..."],
        "seoGeoKeywords": ["..."]
    },
    "localBusinessModelComparison": {
        "localConsumptionHabits": "...",
        "paymentPreferences": ["..."],
        "channelStructure": "...",
        "pricingStrategies": "...",
        "promotionalHabits": ["..."],
        "regulatoryCompliance": ["..."],
        "competitorModelAdaptation": "...",
        "ourModelAdvantages": ["..."],
        "ourModelDisadvantages": ["..."]
    },
    "socialBuzzTrend": {
        "labels": ["..."],
        "datasets": [
            {
                "label": "...",
                "data": [...]
            }
        ]
    },
    "combinedTimeline": [
        {
            "brandName": "...",
            "competitorType": "...",
            "date": "YYYY-MM-DD",
            "title": "...",
            "description": "...",
            "category": "...",
            "isPredicted": false
        }
    ],
    "alerts": [
        {
            "type": "opportunity" or "threat",
            "text": "..."
        }
    ],
    "aiStrategicAnalysis": "..."
}
嚴格僅輸出此 JSON，不能有任何說明、標註或其他內容。`;

    const payload = {
        contents: [{ role: "user", parts: [{ text: prompt }] }],
        generationConfig: {
            responseMimeType: "application/json",
        }
    };

    const apiKey = localStorage.getItem('gemini_api_key') || '';
    if (!apiKey) throw new Error('請先輸入並儲存 Google Gemini API Key');
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-pro:generateContent?key=${apiKey}`;

    const response = await fetch(apiUrl, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
    });

    if (!response.ok) {
        const errorBody = await response.text();
        throw new Error(`API 請求失敗，狀態碼：${response.status}. 回應: ${errorBody}`);
    }

    const result = await response.json();
    let aiText = "";
    if (
        result.candidates &&
        result.candidates[0].content &&
        result.candidates[0].content.parts &&
        result.candidates[0].content.parts[0].text
    ) {
        aiText = result.candidates[0].content.parts[0].text;
    } else {
        throw new Error("AI 未能生成有效的分析資料。");
    }

    // 【加強版清理】
    aiText = aiText.replace(/```json|```/g, "").trim();
    aiText = aiText
        .split('\n')
        .filter(line => !line.trim().startsWith('//'))
        .join('\n');
    const firstBrace = aiText.indexOf('{');
    const lastBrace = aiText.lastIndexOf('}');
    if (firstBrace !== -1 && lastBrace !== -1 && lastBrace > firstBrace) {
        aiText = aiText.substring(firstBrace, lastBrace + 1);
    }
    try {
        return JSON.parse(aiText);
    } catch (e) {
        console.error("JSON 解析失敗:", e);
        console.error("收到的無效 JSON 字串:", aiText);
        throw new Error(`AI 回應的內容不是有效的 JSON 格式。請檢查 API Key、Prompt、或內容長度。原始內容如下：\n` + aiText);
    }
}

function renderResults(data) {
    renderSocialBuzzChart(data.socialBuzzTrend);
    renderComparisonTable(data.analysisResults);
    renderMetricComparisonChart(data.analysisResults);
    renderAIOBrandAwareness(data.analysisResults);
    renderRapidSentimentPulse(data.rapidSentimentPulse);
    renderQDACFramework(data.qdacFramework);
    renderMarketEntryStrategy(data.marketEntryStrategy);
    renderIndustryAnalysis(data.industryAnalysis);
    renderProductClarification(data.productClarification);
    renderLanguageRecommendations(data.languageRecommendations);
    renderLocalBusinessModelComparison(data.localBusinessModelComparison);
    renderTimeline(data.combinedTimeline);
    renderAlerts(data.alerts);
    summaryContainer.innerHTML = data.aiStrategicAnalysis.replace(/\n/g, '<br>');
}

async function downloadReport() {
    const content = document.getElementById('downloadable-content');
    if (!content) return;
    const originalButtonText = downloadBtn.innerHTML;
    downloadBtn.innerHTML = '<span>正在產生報告...</span>';
    downloadBtn.disabled = true;
    await new Promise(resolve => setTimeout(resolve, 100));
    try {
        const canvas = await html2canvas(content, {
            scale: 2, 
            useCORS: true,
            backgroundColor: '#ffffff'
        });
        const imgData = canvas.toDataURL('image/png');
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'p',
            unit: 'mm',
            format: 'a4'
        });
        const pdfWidth = pdf.internal.pageSize.getWidth();
        const pdfHeight = pdf.internal.pageSize.getHeight();
        const canvasWidth = canvas.width;
        const canvasHeight = canvas.height;
        const imgWidth = pdfWidth - 20;
        const imgHeight = (canvasHeight * imgWidth) / canvasWidth;
        let heightLeft = imgHeight;
        let position = 10;
        pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
        heightLeft -= (pdfHeight - 20);
        while (heightLeft > 0) {
            position = position - pdfHeight + 20;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 10, position, imgWidth, imgHeight);
            heightLeft -= (pdfHeight - 20);
        }
        pdf.save('AI競品分析報告.pdf');
    } catch (error) {
        console.error("PDF generation failed:", error);
        showError("報告下載失敗，請稍後再試。");
    } finally {
         downloadBtn.innerHTML = originalButtonText;
         downloadBtn.disabled = false;
    }
}

function renderSocialBuzzChart(trendData) {
    if (!trendData || !trendData.labels || !Array.isArray(trendData.datasets)) {
        socialBuzzChartCanvas.parentNode.innerHTML = '<div class="text-red-500 p-4">AI 沒有產生有效的社群聲量資料。</div>';
        return;
    }
    if (socialBuzzChart) {
        socialBuzzChart.destroy();
    }
    const brandColors = {
        my_brand: '#4f46e5',
        direct: '#db2777',
        indirect: '#f59e0b',
        potential: '#10b981',
    };
    const datasets = trendData.datasets.map(ds => {
        const brandInfo = findBrandInfo(ds.label);
        return {
            ...ds,
            borderColor: brandColors[brandInfo.type] || '#6b7280',
            backgroundColor: (brandColors[brandInfo.type] || '#6b7280') + '33',
            tension: 0.2,
            fill: true,
        }
    });
    socialBuzzChart = new Chart(socialBuzzChartCanvas, {
        type: 'line',
        data: {
            labels: trendData.labels,
            datasets: datasets,
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                y: {
                    beginAtZero: true,
                    title: {
                        display: true,
                        text: '社群聲量指數'
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top',
                },
            }
        }
    });
}

function renderComparisonTable(results) {
    comparisonTable.innerHTML = '';
    if (!Array.isArray(results) || !results.length) {
        comparisonTable.innerHTML = '<tr><td class="p-4 text-gray-500">無法取得競品比較資料。</td></tr>';
        return;
    }
    const tenDimensionMatrix = [
        { key: 'productFeatureDensity', label: '產品特徵密度', group: '產品與創新' },
        { key: 'pricePositioningElasticity', label: '價格定位彈性', group: '市場與定價' },
        { key: 'digitalAuthorityFootprint', label: '數位權威與足跡', group: '數位影響力' },
        { key: 'socialEngagementVelocity', label: '社群互動速率', group: '社群與互動' },
        { key: 'customerSentimentPolarity', label: '客戶情緒極性', group: '客戶體驗' },
        { key: 'distributionNetworkBreadth', label: '通路網絡廣度', group: '通路與分銷' },
        { key: 'innovationCadence', label: '創新節奏', group: '產品與創新' },
        { key: 'sustainabilityCSR', label: '永續與企業社會責任', group: '企業責任' },
        { key: 'customerSupportResponsiveness', label: '客戶支援響應度', group: '客戶體驗' },
        { key: 'brandNarrativeConsistency', label: '品牌敘事一致性', group: '品牌與行銷' },
    ];
    
    const analysisGroups = [
        {
            title: '產品與創新',
            description: '產品特徵、創新能力',
            bgClass: 'bg-indigo-50',
            textClass: 'text-indigo-700',
            fields: tenDimensionMatrix.filter(f => f.group === '產品與創新')
        },
        {
            title: '市場與定價',
            description: '定價策略、通路佈局',
            bgClass: 'bg-amber-50',
            textClass: 'text-amber-700',
            fields: tenDimensionMatrix.filter(f => f.group === '市場與定價')
        },
        {
            title: '數位影響力',
            description: '數位權威、社群互動',
            bgClass: 'bg-purple-50',
            textClass: 'text-purple-700',
            fields: tenDimensionMatrix.filter(f => f.group === '數位影響力')
        },
        {
            title: '客戶體驗',
            description: '情緒、支援響應',
            bgClass: 'bg-green-50',
            textClass: 'text-green-700',
            fields: tenDimensionMatrix.filter(f => f.group === '客戶體驗')
        },
        {
            title: '企業責任與品牌',
            description: '永續、品牌一致性',
            bgClass: 'bg-emerald-50',
            textClass: 'text-emerald-700',
            fields: tenDimensionMatrix.filter(f => f.group === '企業責任' || f.group === '品牌與行銷')
        },
    ];
const publicInfoSourcesData = [
    {
        title: '競品公開資訊',
        description: '以公開管道驗證功能與品牌聲量',
        borderClass: 'border-slate-200',
        bgClass: 'bg-white',
        items: [
            {
                label: '官網與產品頁',
                note: '檢視功能描述、定價、通路佈局、在地化訊息。',
                tooltip: '可加入章節連結或快照，對應「功能」「體驗」「定價/通路」欄位。'
            },
            {
                label: 'App/Platform 評分',
                note: 'App Store、Google Play、SaaS 評價可說明 UI 流暢度與信任感。',
                tooltip: '實際分數、更新頻率、熱門評論可驗證「體驗」與「品牌信任度」。'
            },
            {
                label: '新聞與媒體報導',
                note: '觀察品牌曝光、正負聲量、危機事件與合作消息。',
                tooltip: '能補強「品牌聲譽」「負面訊息」對資源與策略的影響評估。'
            }
        ]
    }
];
const sourceValidationLinks = [
    {
        label: '官網與產品/定價頁',
        url: 'https://example.com/competitor-product',
        description: '比對功能清單、套餐與通路佈局，可補 evidence。',
        tooltip: '適合用來驗證「功能」「價值」「價格」等欄位內容。'
    },
    {
        label: 'App Store / Google Play 評分',
        url: 'https://example.com/competitor-app',
        description: '查看評分、評論與更新頻率，驗證 UI/UX 與信任度。',
        tooltip: '社群聲量與體驗感可從評分/熱門評論擷取。'
    },
    {
        label: '新聞 / 專業媒體報導',
        url: 'https://example.com/competitor-news',
        description: '追蹤品牌曝光、社群熱點與負面事件。',
        tooltip: '好用於補强「品牌聲譽」「負面聲量」與策略脈絡。'
    }
];
const dimensionGuideData = [
    {
        title: '核心體驗',
        description: '觀察產品定位、功能、體驗與價值主張的差異',
        items: [
            { label: '產品定位', definition: '品牌主張與價值訴求', sources: '品牌說明、AI 分析', radar: '更新頻率' },
            { label: '用戶需求', definition: '痛點/偏好與產品匹配度', sources: 'Persona、社群/報導', radar: '社群聲量' },
            { label: '功能對比', definition: '功能完整度與創新程度', sources: '官網/產品頁', radar: 'App 評分' },
            { label: 'UI/UX', definition: '界面流暢度與互動品質', sources: 'App 評分、使用者口碑', radar: 'App 評分' },
        ]
    },
    {
        title: '市場 / 行銷',
        description: '比對文案、視覺、定價與通路策略',
        items: [
            { label: '文案風格', definition: '行銷語調與用詞定位', sources: '社群/廣告', radar: '社群聲量' },
            { label: '視覺品牌感', definition: '視覺一致性與認知度', sources: '官網/廣告素材', radar: '社群聲量' },
            { label: '盈利定價', definition: '收費模式與套餐策略', sources: '公開定價、報價單', radar: '更新頻率' },
            { label: '行銷通路', definition: '投放渠道與合作網絡', sources: '媒體報導、代理公告', radar: '社群聲量' },
        ]
    },
    {
        title: '資源能力 / 策略彈性',
        description: '品牌聲譽、資源與營運彈性的觀察',
        items: [
            { label: '營運策略', definition: '運營/客服節奏與資源佈局', sources: 'AI 分析、內部觀察', radar: '更新頻率' },
        ]
    }
];
const metricChartLabels = ['更新頻率', '社群聲量', 'App 評分'];
const metricChartKeys = ['updateFrequency', 'socialShare', 'appRating'];
const metricColorPalette = ['#6366f1', '#ef4444', '#f59e0b', '#10b981'];
    const thead = document.createElement('thead');
    let headerRow = '<tr class="table-sticky-header">';
    headerRow += '<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider w-1/5">分析維度</th>';
    results.forEach(brand => {
        headerRow += `<th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
            <div class="flex flex-col">
                <span class="text-base font-bold text-gray-800">${brand.brandName}</span>
                <span class="text-xs font-medium ${getCompetitorTypeColor(brand.competitorType)}">${formatCompetitorType(brand.competitorType)}</span>
            </div>
        </th>`;
    });
    headerRow += '</tr>';
    thead.innerHTML = headerRow;
    comparisonTable.appendChild(thead);
    const tbody = document.createElement('tbody');
    tbody.className = "bg-white divide-y divide-gray-200";
    analysisGroups.forEach(group => {
        const groupRow = document.createElement('tr');
        groupRow.className = `${group.bgClass} border-t border-gray-200`;
        const groupCell = document.createElement('td');
        groupCell.colSpan = results.length + 1;
        groupCell.className = `px-6 py-2 text-sm font-semibold ${group.textClass}`;
        groupCell.innerHTML = `
            <span class="uppercase tracking-wider">${group.title}</span>
            <span class="ml-3 text-xs font-normal text-gray-600">${group.description}</span>
        `;
        groupRow.appendChild(groupCell);
        tbody.appendChild(groupRow);

        group.fields.forEach(item => {
            const row = document.createElement('tr');
            row.innerHTML = `<td class="px-6 py-4 whitespace-nowrap font-bold text-gray-900 align-top">${item.label}</td>`;
            results.forEach(brand => {
                let analysisText = 'N/A';
                let sourceText = null;
                let metrics = null;
                let score = null;
                
                if (brand.tenDimensionMatrix && brand.tenDimensionMatrix[item.key]) {
                    const dimData = brand.tenDimensionMatrix[item.key];
                    analysisText = dimData.analysis || 'N/A';
                    sourceText = dimData.source || null;
                    metrics = dimData.metrics || null;
                    score = dimData.score !== undefined ? dimData.score : null;
                } else if (brand.analysis && brand.analysis[item.key]) {
                    analysisText = brand.analysis[item.key];
                    sourceText = getSourceText(brand, item.key);
                    metrics = getMetricsForKey(brand, item.key);
                }
                
                const cell = document.createElement('td');
                cell.className = 'px-6 py-4 whitespace-pre-wrap align-top';
                cell.innerHTML = `
                    ${score !== null ? `<div class="text-lg font-bold text-indigo-600 mb-2">${score}/10</div>` : ''}
                    <div>${analysisText}</div>
                    ${sourceText ? `<div class="text-xs text-gray-500 mt-2">來源：${sourceText}</div>` : ''}
                    ${metrics ? `<div class="text-xs text-indigo-600 mt-1">${formatMetricsText(metrics)}</div>` : ''}
                `;
                row.appendChild(cell);
            });
            tbody.appendChild(row);
        });
    });
    comparisonTable.appendChild(tbody);
    renderComparisonSources();
}

function renderMetricComparisonChart(results) {
    if (!metricComparisonChartCanvas) return;
    if (!results || !results.length) {
        if (metricComparisonChart) {
            metricComparisonChart.destroy();
            metricComparisonChart = null;
        }
        return;
    }
    
    const tenDimensionLabels = [
        '產品特徵密度', '價格定位彈性', '數位權威', '社群互動', '客戶情緒',
        '通路網絡', '創新節奏', '永續CSR', '客戶支援', '品牌一致性'
    ];
    const tenDimensionKeys = [
        'productFeatureDensity', 'pricePositioningElasticity', 'digitalAuthorityFootprint',
        'socialEngagementVelocity', 'customerSentimentPolarity', 'distributionNetworkBreadth',
        'innovationCadence', 'sustainabilityCSR', 'customerSupportResponsiveness', 'brandNarrativeConsistency'
    ];
    
    const datasets = results.map((brand, index) => {
        const color = metricColorPalette[index % metricColorPalette.length];
        const data = tenDimensionKeys.map(key => {
            if (brand.tenDimensionMatrix && brand.tenDimensionMatrix[key] && brand.tenDimensionMatrix[key].score !== undefined) {
                return brand.tenDimensionMatrix[key].score;
            }
            return 0;
        });
        return {
            label: `${brand.brandName}`,
            data: data,
            borderColor: color,
            backgroundColor: `${color}40`,
            pointBackgroundColor: color,
            pointBorderColor: '#fff',
            borderWidth: 2,
        };
    });
    const config = {
        type: 'radar',
        data: {
            labels: tenDimensionLabels,
            datasets,
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    beginAtZero: true,
                    suggestedMin: 0,
                    suggestedMax: 10,
                    ticks: {
                        backdropColor: 'rgba(255,255,255,0.4)'
                    },
                    pointLabels: {
                        font: {
                            size: 12
                        }
                    }
                }
            },
            plugins: {
                legend: {
                    position: 'top'
                }
            }
        }
    };
    if (metricComparisonChart) {
        metricComparisonChart.destroy();
    }
    const ctx = metricComparisonChartCanvas.getContext('2d');
    metricComparisonChart = new Chart(ctx, config);
}

function renderComparisonSources() {
    const container = document.getElementById('comparison-sources');
    if (!container) return;
    container.innerHTML = comparisonSourcesData.map(group => `
        <div class="rounded-xl border ${group.borderClass} ${group.bgClass} p-4 shadow-sm">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-800">${group.title}</h3>
                <span class="text-xs uppercase tracking-wider text-gray-500">來源</span>
            </div>
            <p class="text-xs text-gray-600 mb-3">${group.description}</p>
            <ul class="text-xs space-y-1">
                ${group.sources.map(source => `
                    <li class="flex items-start gap-2" title="${source.tooltip}">
                        <span class="text-indigo-600 text-sm">•</span>
                        <div>
                            <p class="font-medium text-gray-800">${source.label}</p>
                            <p class="text-gray-500">${source.note}</p>
                        </div>
                    </li>
                `).join('')}
            </ul>
        </div>
    `).join('');
    container.classList.remove('hidden');
    renderPublicInfoSources();
    renderDimensionGuide();
}

function renderPublicInfoSources() {
    const container = document.getElementById('public-info-sources');
    if (!container) return;
    container.innerHTML = publicInfoSourcesData.map(group => `
        <div class="rounded-2xl border ${group.borderClass} ${group.bgClass} p-5 shadow-sm">
            <div class="flex items-center justify-between">
                <h3 class="text-sm font-semibold text-gray-800">${group.title}</h3>
            </div>
            <p class="text-xs text-gray-500 mb-3">${group.description}</p>
            <ul class="space-y-3 text-sm">
                ${group.items.map(item => `
                    <li class="text-gray-700" title="${item.tooltip}">
                        <p class="font-semibold">${item.label}</p>
                        <p class="text-xs text-gray-500">${item.note}</p>
                    </li>
                `).join('')}
            </ul>
        </div>
    `).join('');
    container.classList.remove('hidden');
}

function renderDimensionGuide() {
    const container = document.getElementById('dimension-guide');
    if (!container) return;
    container.innerHTML = dimensionGuideData.map(group => `
        <div class="rounded-2xl border border-gray-200 p-4 bg-gray-50">
            <p class="text-xs font-semibold uppercase text-gray-500">${group.title}</p>
            <p class="text-sm font-semibold text-gray-800 mt-1">${group.description}</p>
            <ul class="mt-3 text-xs space-y-2 text-gray-600">
                ${group.items.map(item => `
                    <li>
                        <p class="font-semibold text-gray-800">${item.label}</p>
                        <p>${item.definition}</p>
                        <p class="text-gray-500">來源：${item.sources} · Radar：${item.radar}</p>
                    </li>
                `).join('')}
            </ul>
        </div>
    `).join('');
}

function renderSourceValidationLinks() {
    const container = document.getElementById('source-validation-list');
    if (!container) return;
    container.innerHTML = sourceValidationLinks.map(link => `
        <div class="rounded-lg border border-gray-200 p-4 shadow-sm transition hover:shadow-md">
            <div class="flex items-center justify-between">
                <p class="text-sm font-semibold">${link.label}</p>
                <span class="text-xs text-gray-500"> ${link.tooltip}</span>
            </div>
            <p class="text-xs text-gray-600 mt-2">${link.description}</p>
            <a href="${link.url}" target="_blank" rel="noreferrer" class="text-indigo-600 text-xs font-semibold inline-flex items-center mt-2">
                開啟檢視
                <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 ml-1" viewBox="0 0 20 20" fill="currentColor"><path d="M10 6l6 6-6 6" /></svg>
            </a>
        </div>
    `).join('');
}

function toggleSourceValidationModal(show) {
    const modal = document.getElementById('source-validation-modal');
    if (!modal) return;
    modal.classList.toggle('hidden', !show);
}

function getSourceText(brand, key) {
    if (!brand) return null;
    if (brand.analysisSources && brand.analysisSources[key]) {
        return brand.analysisSources[key];
    }
    if (brand.analysis && brand.analysis[`${key}Source`]) {
        return brand.analysis[`${key}Source`];
    }
    return brand.source || null;
}

function getMetricsForKey(brand, key) {
    if (!brand) return null;
    if (brand.quantifiedMetrics && brand.quantifiedMetrics[key]) {
        return brand.quantifiedMetrics[key];
    }
    if (brand.analysis && brand.analysis.quantifiedMetrics && brand.analysis.quantifiedMetrics[key]) {
        return brand.analysis.quantifiedMetrics[key];
    }
    return null;
}

const metricLabelMap = {
    updateFrequency: '更新頻率',
    socialShare: '社群聲量',
    appRating: 'App 評分'
};

function formatMetricsText(metrics) {
    if (!metrics) return '';
    const entries = Object.entries(metrics).map(([metricKey, value]) => {
        const label = metricLabelMap[metricKey] || metricKey;
        return `${label} ${value}`;
    }).filter(Boolean);
    return entries.join(' · ');
}

function aggregateMetricValue(brand, metricKey) {
    const metricsSource = brand.quantifiedMetrics || (brand.analysis && brand.analysis.quantifiedMetrics);
    if (!metricsSource) return 0;
    const numericValues = Object.values(metricsSource)
        .map(metric => metric && parseNumericValue(metric[metricKey]))
        .filter(value => Number.isFinite(value));
    if (!numericValues.length) return 0;
    const sum = numericValues.reduce((total, value) => total + value, 0);
    return sum / numericValues.length;
}

function parseNumericValue(value) {
    if (typeof value === 'number') return value;
    if (!value) return NaN;
    const cleaned = value.toString().replace(/,/g, '.');
    const match = cleaned.match(/[\d.]+/);
    return match ? parseFloat(match[0]) : NaN;
}

function loadSnapshots() {
    try {
        const stored = localStorage.getItem(snapshotStorageKey);
        return stored ? JSON.parse(stored) : [];
    } catch (error) {
        console.error('快照讀取失敗:', error);
        return [];
    }
}

function persistSnapshots() {
    localStorage.setItem(snapshotStorageKey, JSON.stringify(analysisSnapshots));
}

function renderSnapshotList() {
    const container = document.getElementById('analysis-snapshots');
    const list = document.getElementById('analysis-snapshot-list');
    if (!container || !list) return;
    if (!analysisSnapshots.length) {
        container.classList.add('hidden');
        list.innerHTML = '';
        return;
    }
    container.classList.remove('hidden');
    list.innerHTML = analysisSnapshots.map(snapshot => `
        <div class="border border-gray-200 rounded-2xl p-4 shadow-sm bg-gray-50">
            <div class="flex items-center justify-between mb-2">
                <div>
                    <p class="text-xs text-gray-500">${new Date(snapshot.timestamp).toLocaleString()}</p>
                    <p class="text-sm font-semibold text-gray-800">${snapshot.brand} / ${snapshot.region}</p>
                </div>
                <div class="text-xs text-gray-500">競品 ${snapshot.competitors.length}</div>
            </div>
            <p class="text-xs text-gray-600 h-12 overflow-hidden">${snapshot.summary || snapshot.aiStrategicAnalysis || ''}</p>
            <div class="flex items-center justify-end gap-2 mt-3">
                <button data-action="replay" data-snapshot-id="${snapshot.id}" class="px-3 py-1 text-xs font-semibold text-white bg-indigo-600 rounded-full hover:bg-indigo-700 transition">重播</button>
                <button data-action="delete" data-snapshot-id="${snapshot.id}" class="px-3 py-1 text-xs font-semibold text-gray-600 bg-white border border-gray-300 rounded-full hover:bg-gray-100 transition">刪除</button>
            </div>
        </div>
    `).join('');
    list.querySelectorAll('button[data-action="replay"]').forEach(button => {
        button.addEventListener('click', () => replaySnapshot(button.dataset.snapshotId));
    });
    list.querySelectorAll('button[data-action="delete"]').forEach(button => {
        button.addEventListener('click', () => deleteSnapshot(button.dataset.snapshotId));
    });
}

function saveSnapshot() {
    if (!lastAnalysisData || !lastInputState) {
        showError('請先完成一次分析後再儲存快照。');
        return;
    }
    const snapshot = {
        id: `snapshot-${Date.now()}`,
        timestamp: new Date().toISOString(),
        region: lastInputState.region,
        brand: lastInputState.brand.name,
        goal: lastInputState.brand.goal,
        persona: lastInputState.brand.persona,
        competitors: lastInputState.competitors.map(comp => ({ ...comp })),
        summary: lastAnalysisData.aiStrategicAnalysis || '',
        analysisResults: lastAnalysisData.analysisResults || [],
        socialBuzzTrend: lastAnalysisData.socialBuzzTrend || {},
        alerts: lastAnalysisData.alerts || []
    };
    analysisSnapshots = [snapshot, ...analysisSnapshots].slice(0, snapshotLimit);
    persistSnapshots();
    renderSnapshotList();
}

function replaySnapshot(id) {
    const snapshot = analysisSnapshots.find(item => item.id === id);
    if (!snapshot) return;
    myBrandInput.value = snapshot.brand;
    myGoalInput.value = snapshot.goal;
    myPersonaInput.value = snapshot.persona;
    competitorList.innerHTML = '';
    if (snapshot.competitors && snapshot.competitors.length) {
        snapshot.competitors.forEach(data => addCompetitorField(data));
    } else {
        addCompetitorField();
    }
    if (marketSelect) {
        marketSelect.value = snapshot.region || appState.currentRegion;
        updateMarketContext(marketSelect.value);
    }
    handleAnalysis();
}

function deleteSnapshot(id) {
    analysisSnapshots = analysisSnapshots.filter(item => item.id !== id);
    persistSnapshots();
    renderSnapshotList();
}

function renderTimeline(events) {
    timelineContainer.innerHTML = '';
    if (!events || events.length === 0) {
        timelineContainer.innerHTML = '<p class="text-gray-500 p-4">AI 未能找到相關的行銷活動。</p>';
        return;
    }

    // 只顯示最近一年內的事件
    const now = new Date();
    const oneYearAgo = new Date(now);
    oneYearAgo.setFullYear(now.getFullYear() - 1);

    const filteredEvents = events.filter(event => {
        const eventDate = new Date(event.date);
        return eventDate >= oneYearAgo && eventDate <= now;
    });

    if (filteredEvents.length === 0) {
        timelineContainer.innerHTML = '<p class="text-gray-500 p-4">最近一年內無相關行銷活動。</p>';
        return;
    }

    filteredEvents.forEach(event => {
        const timelineItemClass = `timeline-item-${event.competitorType}`;
        const categoryColor = getEventCategoryColor(event.category);
        const isPredictedClass = event.isPredicted ? 'predicted-event' : '';
        const item = document.createElement('div');
        item.className = `timeline-item relative mb-6 ${timelineItemClass}`;
        item.innerHTML = `
            <div class="ml-10">
                <span class="absolute -left-10 text-sm font-semibold text-gray-500">${event.date}</span>
                <div class="p-4 bg-gray-50 rounded-lg border-2 ${isPredictedClass} border-gray-200">
                   <div class="flex justify-between items-center mb-2">
                       <span class="font-semibold px-2.5 py-0.5 rounded-full text-xs ${categoryColor.bg} ${categoryColor.text}">${event.category} ${event.isPredicted ? '(預測)' : ''}</span>
                       <span class="font-bold text-sm ${getCompetitorTypeColor(event.competitorType)}">${event.brandName}</span>
                   </div>
                   <h3 class="text-lg font-bold text-gray-800">${event.title}</h3>
                   <p class="text-gray-600 mt-1">${event.description}</p>
                </div>
            </div>
        `;
        timelineContainer.appendChild(item);
    });
}

function renderAlerts(alerts) {
    alertsContainer.innerHTML = '';
    if (!alerts || alerts.length === 0) {
        alertsContainer.innerHTML = '<p class="text-gray-500">目前無重大機會或威脅警報。</p>';
        return;
    }
    alerts.forEach(alert => {
        const isOpportunity = alert.type === 'opportunity';
        const bgColor = isOpportunity ? 'bg-green-50' : 'bg-red-50';
        const borderColor = isOpportunity ? 'border-green-500' : 'border-red-500';
        const iconColor = isOpportunity ? 'text-green-500' : 'text-red-500';
        const iconSvg = isOpportunity 
            ? `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 17l-5-5m0 0l5-5m-5 5h12" /></svg>`
            : `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 17h8m0 0V9a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2h8z" /></svg>`;
        const alertEl = document.createElement('div');
        alertEl.className = `flex items-start p-4 rounded-lg border-l-4 ${bgColor} ${borderColor}`;
        alertEl.innerHTML = `
            <div class="flex-shrink-0 ${iconColor}">${iconSvg}</div>
            <div class="ml-3">
                <p class="text-sm font-medium text-gray-800">${alert.text}</p>
            </div>
        `;
        alertsContainer.appendChild(alertEl);
    });
}

function findBrandInfo(brandName) {
    if (brandName === myBrandInput.value.trim()) {
        return { type: 'my_brand' };
    }
    const competitorEl = Array.from(competitorList.children).find(div => div.querySelector('input').value.trim() === brandName);
    return competitorEl ? { type: competitorEl.querySelector('select').value } : { type: 'direct' };
}

function getEventCategoryColor(category) {
    const colors = {
        "產品發布": { bg: "bg-blue-100", text: "text-blue-800" },
        "社群活動": { bg: "bg-pink-100", text: "text-pink-800" },
        "代言人合作": { bg: "bg-purple-100", text: "text-purple-800" },
        "公關危機": { bg: "bg-red-100", text: "text-red-800" },
        "節日行銷": { bg: "bg-green-100", text: "text-green-800" },
        "線下活動": { bg: "bg-yellow-100", text: "text-yellow-800" },
        "default": { bg: "bg-gray-100", text: "text-gray-800" }
    };
    return colors[category] || colors["default"];
}

function getCompetitorTypeColor(type) {
    const colors = {
        my_brand: 'text-indigo-600',
        direct: 'text-red-600',
        indirect: 'text-yellow-600',
        potential: 'text-green-600'
    };
    return colors[type] || 'text-gray-500';
}

function formatCompetitorType(type) {
    const labels = {
        my_brand: '我方品牌',
        direct: '直接競品',
        indirect: '間接競品',
        potential: '潛在競品'
    };
    return labels[type] || type;
}

function renderAIOBrandAwareness(results) {
    const container = document.getElementById('aio-awareness-container');
    if (!container) return;
    if (!results || !results.length) {
        container.innerHTML = '<p class="text-gray-500">AIO 品牌感知資料尚未產生。</p>';
        return;
    }
    
    const aioDimensions = [
        { key: 'mentionVolume', label: '提及聲量 (AI Signal Rate)', desc: 'AI生成回應中品牌出現頻率' },
        { key: 'generativeShareOfVoice', label: '生成式佔有率 (G-SoV)', desc: '在所有競品提及中本品牌佔比' },
        { key: 'rankPositioning', label: '排名與位序', desc: 'AI列表式回答中的順位' },
        { key: 'sentimentOfMention', label: '提及情緒', desc: 'AI提及品牌時的形容詞與語境情緒' },
        { key: 'entityAssociationStrength', label: '實體關聯強度', desc: '品牌與關鍵概念連結緊密度' },
        { key: 'citationAccuracyTrust', label: '引用準確性與信任度', desc: 'AI生成資訊的正確性與可信度' },
        { key: 'recommendationIntensity', label: '推薦強度', desc: '被動提及 vs 主動推薦的區分' },
    ];
    
    container.innerHTML = results.map(brand => {
        const aio = brand.aioBrandAwareness || {};
        return `
            <div class="border rounded-lg p-4 mb-4">
                <h3 class="font-bold text-lg mb-3 ${getCompetitorTypeColor(brand.competitorType)}">${brand.brandName}</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    ${aioDimensions.map(dim => {
                        const data = aio[dim.key] || {};
                        return `
                            <div class="bg-gray-50 p-3 rounded">
                                <div class="font-semibold text-sm text-gray-700">${dim.label}</div>
                                <div class="text-xs text-gray-500 mb-1">${dim.desc}</div>
                                ${data.value ? `<div class="text-lg font-bold text-indigo-600">${data.value}</div>` : ''}
                                ${data.analysis ? `<div class="text-sm text-gray-600 mt-2">${data.analysis}</div>` : ''}
                                ${data.source ? `<div class="text-xs text-gray-400 mt-1">來源：${data.source}</div>` : ''}
                            </div>
                        `;
                    }).join('')}
                </div>
            </div>
        `;
    }).join('');
}

function renderRapidSentimentPulse(sentimentData) {
    const container = document.getElementById('sentiment-pulse-container');
    if (!container) return;
    if (!sentimentData) {
        container.innerHTML = '<p class="text-gray-500">快速情緒脈動資料尚未產生。</p>';
        return;
    }
    
    const overall = sentimentData.overallSentimentNet || {};
    const topics = sentimentData.topicModeling || [];
    const triggers = sentimentData.sentimentTriggers || [];
    const spikes = sentimentData.spikeAlerts || [];
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="bg-gradient-to-r from-green-50 to-red-50 p-4 rounded-lg">
                <h3 class="font-bold mb-2">整體情緒淨值</h3>
                <div class="space-y-2">
                    <div class="flex justify-between">
                        <span>正面</span>
                        <span class="font-bold text-green-600">${overall.positive || 0}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>負面</span>
                        <span class="font-bold text-red-600">${overall.negative || 0}%</span>
                    </div>
                    <div class="flex justify-between">
                        <span>中性</span>
                        <span class="font-bold text-gray-600">${overall.neutral || 0}%</span>
                    </div>
                </div>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-bold mb-2">主題建模分析</h3>
                ${topics.length > 0 ? topics.map(topic => `
                    <div class="mb-2">
                        <div class="flex justify-between text-sm">
                            <span>${topic.topic}</span>
                            <span class="font-semibold ${topic.sentiment === 'positive' ? 'text-green-600' : topic.sentiment === 'negative' ? 'text-red-600' : 'text-gray-600'}">${topic.sentiment}</span>
                        </div>
                        <div class="text-xs text-gray-500">${topic.percentage}%</div>
                    </div>
                `).join('') : '<p class="text-sm text-gray-500">無主題資料</p>'}
            </div>
        </div>
        ${triggers.length > 0 ? `
            <div class="bg-yellow-50 p-4 rounded-lg mb-4">
                <h3 class="font-bold mb-2">情緒觸發點</h3>
                <ul class="list-disc list-inside space-y-1">
                    ${triggers.map(trigger => `<li class="text-sm">${trigger}</li>`).join('')}
                </ul>
            </div>
        ` : ''}
        ${spikes.length > 0 ? `
            <div class="bg-red-50 p-4 rounded-lg">
                <h3 class="font-bold mb-2 text-red-700">⚠️ 異常波動檢測</h3>
                ${spikes.map(spike => `
                    <div class="border-l-4 border-red-500 pl-3 mb-2">
                        <div class="font-semibold">${spike.type === 'negative' ? '負面' : '正面'}情緒尖峰</div>
                        <div class="text-sm text-gray-600">${spike.description}</div>
                        <div class="text-xs text-gray-400">${spike.timestamp || ''}</div>
                    </div>
                `).join('')}
            </div>
        ` : ''}
    `;
}

function renderQDACFramework(qdacData) {
    const container = document.getElementById('qdac-framework-container');
    if (!container) return;
    if (!qdacData) {
        container.innerHTML = '<p class="text-gray-500">QDAC 決策框架資料尚未產生。</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-indigo-50 p-4 rounded-lg">
                <h3 class="font-bold text-indigo-700 mb-2">Q - Question (問題)</h3>
                <p class="text-sm">${qdacData.question || '尚未定義戰略問題'}</p>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-bold text-blue-700 mb-2">D - Data (數據)</h3>
                <p class="text-sm">${qdacData.data || '尚未選擇數據工具與指標'}</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <h3 class="font-bold text-green-700 mb-2">A - Analysis (分析)</h3>
                <p class="text-sm">${qdacData.analysis || '尚未進行數據模式分析'}</p>
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <h3 class="font-bold text-purple-700 mb-2">C - Communication (溝通)</h3>
                <p class="text-sm">${qdacData.communication || '尚未制定決策溝通方案'}</p>
            </div>
        </div>
    `;
}

function renderMarketEntryStrategy(strategyData) {
    const container = document.getElementById('market-entry-container');
    if (!container) return;
    if (!strategyData) {
        container.innerHTML = '<p class="text-gray-500">市場進入策略資料尚未產生。</p>';
        return;
    }
    
    const opportunities = strategyData.whiteSpaceOpportunities || [];
    const advantages = strategyData.asymmetricAdvantages || [];
    const entryPaths = strategyData.entryPathRecommendations || [];
    const risks = strategyData.riskAssessment || {};
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div class="bg-green-50 p-4 rounded-lg">
                <h3 class="font-bold text-green-700 mb-2">市場機會識別 (白色空間)</h3>
                ${opportunities.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1">
                        ${opportunities.map(opp => `<li class="text-sm">${opp}</li>`).join('')}
                    </ul>
                ` : '<p class="text-sm text-gray-500">尚未識別到明顯機會</p>'}
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-bold text-blue-700 mb-2">不對稱優勢分析</h3>
                ${advantages.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1">
                        ${advantages.map(adv => `<li class="text-sm">${adv}</li>`).join('')}
                    </ul>
                ` : '<p class="text-sm text-gray-500">尚未識別到不對稱優勢</p>'}
            </div>
        </div>
        <div class="bg-amber-50 p-4 rounded-lg mb-4">
            <h3 class="font-bold text-amber-700 mb-2">進入路徑建議</h3>
            ${entryPaths.length > 0 ? entryPaths.map(path => `
                <div class="border-l-4 border-amber-500 pl-3 mb-3">
                    <div class="font-semibold">${path.path}</div>
                    <div class="text-sm text-gray-600 mt-1">${path.rationale || ''}</div>
                    <div class="text-xs mt-1">
                        <span class="px-2 py-1 rounded ${path.riskLevel === 'low' ? 'bg-green-100 text-green-700' : path.riskLevel === 'high' ? 'bg-red-100 text-red-700' : 'bg-yellow-100 text-yellow-700'}">
                            風險等級：${path.riskLevel || 'medium'}
                        </span>
                    </div>
                </div>
            `).join('') : '<p class="text-sm text-gray-500">尚未提供進入路徑建議</p>'}
        </div>
        <div class="bg-red-50 p-4 rounded-lg">
            <h3 class="font-bold text-red-700 mb-2">風險評估與緩解策略</h3>
            ${risks.identifiedRisks && risks.identifiedRisks.length > 0 ? `
                <div class="mb-3">
                    <h4 class="font-semibold text-sm mb-1">識別風險</h4>
                    <ul class="list-disc list-inside space-y-1">
                        ${risks.identifiedRisks.map(risk => `<li class="text-sm">${risk}</li>`).join('')}
                    </ul>
                </div>
            ` : ''}
            ${risks.mitigationStrategies && risks.mitigationStrategies.length > 0 ? `
                <div>
                    <h4 class="font-semibold text-sm mb-1">緩解策略</h4>
                    <ul class="list-disc list-inside space-y-1">
                        ${risks.mitigationStrategies.map(strategy => `<li class="text-sm">${strategy}</li>`).join('')}
                    </ul>
                </div>
            ` : '<p class="text-sm text-gray-500">尚未提供緩解策略</p>'}
        </div>
    `;
}

function renderIndustryAnalysis(industryData) {
    const container = document.getElementById('industry-analysis-container');
    if (!container) return;
    if (!industryData) {
        container.innerHTML = '<p class="text-gray-500">行業分析資料尚未產生。</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-bold text-blue-700 mb-2">行業結構</h3>
                <p class="text-sm text-gray-700">${industryData.industryStructure || '尚未分析'}</p>
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <h3 class="font-bold text-green-700 mb-2">主要玩家</h3>
                ${industryData.keyPlayers && industryData.keyPlayers.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1">
                        ${industryData.keyPlayers.map(player => `<li class="text-sm">${player}</li>`).join('')}
                    </ul>
                ` : '<p class="text-sm text-gray-500">尚未識別</p>'}
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
                <h3 class="font-bold text-yellow-700 mb-2">進入門檻</h3>
                ${industryData.entryBarriers && industryData.entryBarriers.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1">
                        ${industryData.entryBarriers.map(barrier => `<li class="text-sm">${barrier}</li>`).join('')}
                    </ul>
                ` : '<p class="text-sm text-gray-500">尚未分析</p>'}
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <h3 class="font-bold text-purple-700 mb-2">監管環境</h3>
                <p class="text-sm text-gray-700">${industryData.regulatoryEnvironment || '尚未分析'}</p>
            </div>
        </div>
    `;
}

function renderProductClarification(productData) {
    const container = document.getElementById('product-clarification-container');
    if (!container) return;
    if (!productData) {
        container.innerHTML = '<p class="text-gray-500">產品明確化資料尚未產生。</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-4">
            <div class="bg-indigo-50 p-4 rounded-lg">
                <h3 class="font-bold text-indigo-700 mb-2">核心價值主張</h3>
                <p class="text-sm text-gray-700">${productData.coreValueProposition || '尚未明確'}</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-bold text-green-700 mb-2">關鍵功能特色</h3>
                    ${productData.keyFeatures && productData.keyFeatures.length > 0 ? `
                        <ul class="list-disc list-inside space-y-1">
                            ${productData.keyFeatures.map(feature => `<li class="text-sm">${feature}</li>`).join('')}
                        </ul>
                    ` : '<p class="text-sm text-gray-500">尚未列出</p>'}
                </div>
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-bold text-blue-700 mb-2">目標用戶群體</h3>
                    ${productData.targetUserGroups && productData.targetUserGroups.length > 0 ? `
                        <ul class="list-disc list-inside space-y-1">
                            ${productData.targetUserGroups.map(group => `<li class="text-sm">${group}</li>`).join('')}
                        </ul>
                    ` : '<p class="text-sm text-gray-500">尚未定義</p>'}
                </div>
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
                <h3 class="font-bold text-yellow-700 mb-2">使用場景</h3>
                ${productData.useCases && productData.useCases.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1">
                        ${productData.useCases.map(useCase => `<li class="text-sm">${useCase}</li>`).join('')}
                    </ul>
                ` : '<p class="text-sm text-gray-500">尚未描述</p>'}
            </div>
            <div class="bg-purple-50 p-4 rounded-lg">
                <h3 class="font-bold text-purple-700 mb-2">競爭差異化</h3>
                <p class="text-sm text-gray-700">${productData.competitiveDifferentiation || '尚未分析'}</p>
            </div>
        </div>
    `;
}

function renderLanguageRecommendations(langData) {
    const container = document.getElementById('language-recommendations-container');
    if (!container) return;
    if (!langData) {
        container.innerHTML = '<p class="text-gray-500">語言建議資料尚未產生。</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-4">
            <div class="bg-indigo-50 p-4 rounded-lg">
                <h3 class="font-bold text-indigo-700 mb-2">建議語言版本</h3>
                ${langData.recommendedLanguages && langData.recommendedLanguages.length > 0 ? `
                    <div class="flex flex-wrap gap-2">
                        ${langData.recommendedLanguages.map(lang => `
                            <span class="px-3 py-1 bg-indigo-100 text-indigo-700 rounded-full text-sm">${lang}</span>
                        `).join('')}
                    </div>
                ` : '<p class="text-sm text-gray-500">尚未建議</p>'}
            </div>
            <div class="bg-green-50 p-4 rounded-lg">
                <h3 class="font-bold text-green-700 mb-2">本地化關鍵詞與術語</h3>
                ${langData.localizationKeywords && langData.localizationKeywords.length > 0 ? `
                    <div class="space-y-2">
                        ${langData.localizationKeywords.map(kw => `
                            <div class="bg-white p-2 rounded">
                                <div class="font-semibold text-sm">${kw.term || ''} → ${kw.translation || ''}</div>
                                <div class="text-xs text-gray-500">${kw.context || ''}</div>
                            </div>
                        `).join('')}
                    </div>
                ` : '<p class="text-sm text-gray-500">尚未提供</p>'}
            </div>
            <div class="bg-blue-50 p-4 rounded-lg">
                <h3 class="font-bold text-blue-700 mb-2">文化敏感度考量</h3>
                ${langData.culturalSensitivity && langData.culturalSensitivity.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1">
                        ${langData.culturalSensitivity.map(item => `<li class="text-sm">${item}</li>`).join('')}
                    </ul>
                ` : '<p class="text-sm text-gray-500">尚未分析</p>'}
            </div>
            <div class="bg-yellow-50 p-4 rounded-lg">
                <h3 class="font-bold text-yellow-700 mb-2">SEO/GEO 關鍵詞策略</h3>
                ${langData.seoGeoKeywords && langData.seoGeoKeywords.length > 0 ? `
                    <div class="flex flex-wrap gap-2">
                        ${langData.seoGeoKeywords.map(keyword => `
                            <span class="px-3 py-1 bg-yellow-100 text-yellow-700 rounded-full text-sm">${keyword}</span>
                        `).join('')}
                    </div>
                ` : '<p class="text-sm text-gray-500">尚未建議</p>'}
            </div>
        </div>
    `;
}

function renderLocalBusinessModelComparison(businessModelData) {
    const container = document.getElementById('local-business-model-container');
    if (!container) return;
    if (!businessModelData) {
        container.innerHTML = '<p class="text-gray-500">當地市場商業模式比對資料尚未產生。</p>';
        return;
    }
    
    container.innerHTML = `
        <div class="space-y-4">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-blue-50 p-4 rounded-lg">
                    <h3 class="font-bold text-blue-700 mb-2">當地消費習慣</h3>
                    <p class="text-sm text-gray-700">${businessModelData.localConsumptionHabits || '尚未分析'}</p>
                </div>
                <div class="bg-green-50 p-4 rounded-lg">
                    <h3 class="font-bold text-green-700 mb-2">支付偏好</h3>
                    ${businessModelData.paymentPreferences && businessModelData.paymentPreferences.length > 0 ? `
                        <ul class="list-disc list-inside space-y-1">
                            ${businessModelData.paymentPreferences.map(pref => `<li class="text-sm">${pref}</li>`).join('')}
                        </ul>
                    ` : '<p class="text-sm text-gray-500">尚未分析</p>'}
                </div>
                <div class="bg-purple-50 p-4 rounded-lg">
                    <h3 class="font-bold text-purple-700 mb-2">通路結構</h3>
                    <p class="text-sm text-gray-700">${businessModelData.channelStructure || '尚未分析'}</p>
                </div>
                <div class="bg-yellow-50 p-4 rounded-lg">
                    <h3 class="font-bold text-yellow-700 mb-2">定價策略</h3>
                    <p class="text-sm text-gray-700">${businessModelData.pricingStrategies || '尚未分析'}</p>
                </div>
            </div>
            <div class="bg-indigo-50 p-4 rounded-lg">
                <h3 class="font-bold text-indigo-700 mb-2">促銷習慣</h3>
                ${businessModelData.promotionalHabits && businessModelData.promotionalHabits.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1">
                        ${businessModelData.promotionalHabits.map(habit => `<li class="text-sm">${habit}</li>`).join('')}
                    </ul>
                ` : '<p class="text-sm text-gray-500">尚未分析</p>'}
            </div>
            <div class="bg-red-50 p-4 rounded-lg">
                <h3 class="font-bold text-red-700 mb-2">法規與合規要求</h3>
                ${businessModelData.regulatoryCompliance && businessModelData.regulatoryCompliance.length > 0 ? `
                    <ul class="list-disc list-inside space-y-1">
                        ${businessModelData.regulatoryCompliance.map(reg => `<li class="text-sm">${reg}</li>`).join('')}
                    </ul>
                ` : '<p class="text-sm text-gray-500">尚未列出</p>'}
            </div>
            <div class="bg-gray-50 p-4 rounded-lg">
                <h3 class="font-bold text-gray-700 mb-2">競品商業模式適應性</h3>
                <p class="text-sm text-gray-700">${businessModelData.competitorModelAdaptation || '尚未分析'}</p>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-green-50 p-4 rounded-lg border-l-4 border-green-500">
                    <h3 class="font-bold text-green-700 mb-2">我方模式優勢</h3>
                    ${businessModelData.ourModelAdvantages && businessModelData.ourModelAdvantages.length > 0 ? `
                        <ul class="list-disc list-inside space-y-1">
                            ${businessModelData.ourModelAdvantages.map(adv => `<li class="text-sm">${adv}</li>`).join('')}
                        </ul>
                    ` : '<p class="text-sm text-gray-500">尚未識別</p>'}
                </div>
                <div class="bg-red-50 p-4 rounded-lg border-l-4 border-red-500">
                    <h3 class="font-bold text-red-700 mb-2">我方模式劣勢</h3>
                    ${businessModelData.ourModelDisadvantages && businessModelData.ourModelDisadvantages.length > 0 ? `
                        <ul class="list-disc list-inside space-y-1">
                            ${businessModelData.ourModelDisadvantages.map(dis => `<li class="text-sm">${dis}</li>`).join('')}
                        </ul>
                    ` : '<p class="text-sm text-gray-500">尚未識別</p>'}
                </div>
            </div>
        </div>
    `;
}

function showError(message) {
    errorMessage.textContent = message;
    errorMessage.classList.remove('hidden');
}
</script>
</body>
</html>
